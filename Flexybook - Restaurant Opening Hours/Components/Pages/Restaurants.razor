@page "/"
@using Flexybook.ApplicationService.Services
@using Flexybook.Domain.Responses.Restaurant
@using Flexybook.Domain
@using Flexybook___Restaurant_Opening_Hours.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@inject IRestaurantService RestaurantService
@inject NavigationManager NavigationManager
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Restaurants</PageTitle>

<h1>Restaurants</h1>

@if (restaurants == null)
{
    <p>Loading...</p>
}
else if (!restaurants.Any())
{
    <p>No restaurants found.</p>
}
else
{
    <div class="restaurant-list">
        @foreach (var restaurant in restaurants)
        {
            var isOpen = IsRestaurantOpen(restaurant);
            var firstImage = restaurant.Images?.FirstOrDefault();
            var imageUrl = firstImage?.Base64Data ?? "/images/restaurant-interior.jpg";
            
            <NavLink href="@($"/restaurant/{restaurant.Id}")" style="text-decoration: none;">
                <div class="restaurant-card">
                    <div class="restaurant-image" style="background-image: url('@imageUrl');"></div>
                    <div class="restaurant-content">
                        <div class="restaurant-header">
                            <h2>@restaurant.Name</h2>
                            <span class="status @(isOpen ? "open" : "closed")">â€¢ @(isOpen ? "Open" : "Closed")</span>
                        </div>
                        <div class="restaurant-info">@restaurant.Address</div>
                        <div class="restaurant-info">@restaurant.Telephone</div>
                        <div class="restaurant-email">@restaurant.Email</div>
                    </div>
                </div>
            </NavLink>
        }
    </div>
}

@code {
    private IEnumerable<RestaurantResponse>? restaurants;

    protected override async Task OnInitializedAsync()
    {
        restaurants = await RestaurantService.GetAllAsync();
    }

    private bool IsRestaurantOpen(RestaurantResponse restaurant)
    {
        var now = DateTime.Now;
        var today = now.DayOfWeek;
        var currentTime = now.TimeOfDay;

        var todayHours = restaurant.OpeningHours?
            .Where(h => h.Type == OpeningHourType.Restaurant && h.DayOfWeek == today)
            .FirstOrDefault();

        if (todayHours == null) return false;
        
        return currentTime >= todayHours.OpenTime && currentTime <= todayHours.CloseTime;
    }
}
